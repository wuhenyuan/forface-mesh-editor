# 场景相交检查功能使用说明

## 功能概述

在工具栏中新增了两个按钮：
1. **"创建测试文字"** - 绿色按钮，用于在场景中创建测试文字对象
2. **"相交检查"** - 橙色按钮，用于检查文字与模型的相交状态

这些功能使用了精确的 BVH 树检测算法，可以实时检测文字与模型的相交情况。

## 使用步骤

### 1. 创建测试文字
1. 点击工具栏中的绿色"创建测试文字"按钮
2. 系统会自动在场景中创建一个测试文字对象
3. 文字会被放置在模型表面或中心位置

### 2. 执行相交检查
1. 点击工具栏中的橙色"相交检查"按钮
2. 系统会检查所有文字对象与模型的相交状态
3. 结果会在浏览器控制台中详细显示

### 3. 交互测试
1. 拖动文字对象到不同位置（如果支持拖动）
2. 再次点击"相交检查"按钮
3. 观察相交状态的变化

## 实际使用场景

### 场景设置
- **目标网格**: 场景中的 3D 模型（如机器人、立方体等）
- **文字对象**: 用户在模型表面创建的文字
- **实时交互**: 可以拖动文字查看相交状态变化

## 检查结果说明

## 控制台输出示例

### 创建测试文字
```
========== 创建测试文字 ==========
✅ 获取工作区实例成功
✅ 文字管理器获取成功
🎯 找到目标网格数量: 1
📍 找到表面位置: [0.5, 0.2, 0.0]
✅ 测试文字创建成功（表面位置）
📝 当前场景文字对象数量: 1
🎉 文字创建完成！现在可以使用相交检查功能了
```

### 相交检查结果
```
========== 开始相交检查 ==========
✅ 获取工作区实例成功
📝 场景中文字对象数量: 1
🎯 场景中目标网格数量: 1
✅ 布尔操作器准备就绪

--- 检查文字对象 1 ---
📝 文字内容: 测试文字
📝 文字ID: text-001
📐 文字几何体信息:
   - 顶点数: 1234
   - 位置: 0.50, 0.20, 0.00
   - 旋转: 0.0°, 0.0°, 0.0°
   - 缩放: 1.00, 1.00, 1.00

  🎯 与目标网格 1 的相交检查
     网格名称: 机器人模型
     网格类型: Mesh
     网格顶点数: 5678
  🔍 开始综合相交检查...

  📊 === 相交检查结果 ===
  🎯 目标网格: 机器人模型
  📝 文字内容: 测试文字

  📦 边界盒检查:
     - 相交: ✅ 是
     - 原因: bounding boxes intersect
  🌳 BVH 精确检查:
     - 相交: ✅ 是
     - 原因: BVH trees intersect
     - 精度: high

  🎯 最终结果:
     - 相交状态: ✅ 相交
     - 置信度: high
     - 检测方法: comprehensive

  💡 建议: 文字与网格相交，可以执行布尔运算（如雕刻）

✅ 场景相交检查完成！
💡 提示: 你可以拖动文字对象改变位置，然后再次点击按钮查看相交状态的变化
```

### 结果解读

#### 相交状态
- **✅ 相交**: 文字与网格有重叠部分，可以执行布尔运算
- **❌ 不相交**: 文字与网格分离，需要调整位置

#### 置信度
- **high**: 使用了 BVH 精确检测，结果可靠
- **medium**: 仅使用边界盒检测或检测过程中有回退

#### 检测方法
- **comprehensive**: 使用了边界盒 + BVH 综合检测
- **boundingBox**: 仅使用边界盒检测
- **BVH**: 仅使用 BVH 检测

## 常见情况说明

### 1. 没有文字对象
```
⚠️ 场景中没有文字对象
💡 提示: 请先在场景中创建文字对象
```
**解决方案**: 启用文字模式，点击模型表面创建文字

### 2. 没有目标网格
```
❌ 场景中没有目标网格（正方体）
💡 提示: 请确保场景中加载了3D模型
```
**解决方案**: 确保场景中已加载 3D 模型

### 3. 文字几何体缺失
```
⚠️ 文字对象缺少几何体，跳过
```
**解决方案**: 重新创建文字对象或刷新页面

### 4. 实时交互测试
1. 拖动文字到不同位置
2. 点击"相交检查"按钮
3. 观察相交状态变化
4. 重复测试不同位置

## 技术细节

### 检测算法
1. **边界盒检测**: 快速预筛选，检查几何体的包围盒是否相交
2. **BVH 树检测**: 精确检测，基于实际几何体形状进行相交判断
3. **综合检测**: 先用边界盒快速筛选，再用 BVH 精确验证

### 性能优化
- 自动根据几何体复杂度选择检测策略
- 简单几何体使用完整 BVH 检测
- 复杂几何体优先使用边界盒检测

### 错误处理
- 自动回退机制：BVH 检测失败时回退到边界盒检测
- 详细错误日志：帮助诊断问题
- 资源清理：自动清理临时创建的网格对象

## 开发者调试

### 手动测试
```javascript
// 在浏览器控制台中运行工具栏集成测试
import('/src/utils/surfaceText/toolbar-integration-test.js').then(m => m.runAllToolbarTests())

// 运行简化的相交检测测试
import('/src/utils/surfaceText/simple-intersection-test.js').then(m => m.simpleIntersectionTest())
```

### 单独测试 BVH 功能
```javascript
// 快速 BVH 集成测试
import('/src/utils/surfaceText/test-bvh-integration.js').then(m => m.quickBVHTest())
```

### 性能基准测试
```javascript
// BVH 性能基准测试
import('/src/utils/surfaceText/test-bvh-integration.js').then(m => m.bvhPerformanceBenchmark())
```

## 故障排除

### 1. 按钮无响应
- 检查浏览器控制台是否有错误信息
- 确认 three-mesh-bvh 库是否正确加载
- 检查工作区实例是否正确初始化

### 2. 检测结果不准确
- 确认几何体是否有有效的顶点数据
- 检查变换矩阵是否正确应用
- 尝试使用不同的检测选项（useBVH: false）

### 3. 性能问题
- 对于复杂几何体，考虑使用 fastOnly: true
- 检查几何体顶点数，过多时考虑简化
- 监控内存使用，及时清理不需要的几何体

## 相关文件

- `src/components/ToolbarPanel.vue` - 工具栏按钮实现（场景检测版）
- `src/components/EditorLayout.vue` - 组件间通信
- `src/components/WorkspaceViewport.vue` - 场景数据暴露
- `src/utils/surfaceText/BooleanOperator.js` - 核心检测逻辑
- `src/utils/surfaceText/simple-intersection-test.js` - 简化测试和演示
- `src/utils/surfaceText/test-bvh-integration.js` - BVH 集成测试

## 功能特点

### ✅ 优点
- **真实场景**: 检查场景中实际存在的文字和模型
- **实时交互**: 可以拖动文字查看相交状态变化
- **详细信息**: 显示文字的位置、旋转、缩放等详细信息
- **多对象支持**: 同时检查多个文字对象与多个目标网格
- **精确检测**: 使用 BVH 树算法进行精确相交检测

### 🎯 适用场景
- **文字雕刻**: 确认文字是否与模型相交，可以执行雕刻操作
- **位置调整**: 通过拖动文字并检查相交状态来找到合适位置
- **布尔运算**: 在执行布尔运算前验证几何体相交状态
- **调试辅助**: 帮助开发者和用户理解文字与模型的空间关系

### 🔧 交互流程
1. **创建文字** → 在模型表面点击创建文字
2. **拖动调整** → 拖动文字到合适位置
3. **检查相交** → 点击按钮查看相交状态
4. **重复测试** → 继续调整位置并检查
5. **执行操作** → 相交时可以执行雕刻等布尔运算