# 文字系统修复总结

## 修复的问题

### 1. 输入框位置问题
**问题**: 输入框没有在全屏鼠标位置显示，而是使用相对于DOM元素的坐标。

**解决方案**:
- 修改了 `FacePicker.js` 的 `handleClick` 和 `selectFace` 方法，使其能够传递原始鼠标事件
- 更新了 `WorkspaceViewport.vue` 的事件处理器，将原始鼠标事件转发给文字系统
- 修改了 `SurfaceTextManager.js` 的 `handleFaceSelected` 方法，优先使用原始鼠标事件的 `clientX` 和 `clientY` 坐标
- `TextInputOverlay.js` 已经使用 `position: fixed` 和全局坐标，无需修改

### 2. 文字大小问题
**问题**: 文字大小太大，需要按毫米单位缩放（33mm应该是合理大小）。

**解决方案**:
- 修改了 `SurfaceTextManager.js` 中的 `getDefaultTextConfig` 方法
- 将默认文字大小从 `1` 改为 `3`（用户要求的新设置）
- 将默认厚度从 `0.1` 改为 `0.5`（用户要求的新设置）
- 同时调整了相关的倒角参数以保持比例

### 3. 文字颜色更新问题
**问题**: 修改文字颜色无效，选中的文字颜色不会改变。

**原因分析**: 当文字被选中时，系统会创建一个高亮材质来替换原始材质。用户更改颜色时，更改的是原始材质的颜色，但显示的是高亮材质，所以看不到颜色变化。

**解决方案**:
- 修改了 `SurfaceTextManager.js` 中的 `updateTextColor` 方法
- 添加了对选中状态的检测和处理
- 当文字被选中时，同时更新原始材质和高亮材质的颜色

## 新增功能

### 4. 物体选择和变换控制系统
**需求**: 
1. 关闭面拾取后，应该允许整个物体的拾取，然后可以选中的实体添加箭头拖动
2. 选中并拖动改变物体位置的箭头时，应该禁用相机视角的改变

**实现方案**:
- 创建了完整的物体选择系统，包含三个核心组件：
  - `ObjectSelector.js`: 负责物体的选择和高亮
  - `ObjectTransformControls.js`: 负责显示变换控制器（拖动箭头）
  - `ObjectSelectionManager.js`: 统一管理物体选择和变换控制

**核心功能**:
1. **智能模式切换**: 禁用面拾取时自动启用物体选择，启用面拾取时自动禁用物体选择
2. **物体选择**: 点击物体可以选中整个物体，支持高亮显示
3. **变换控制器**: 选中物体后显示拖动箭头，支持移动、旋转、缩放三种模式
4. **相机控制管理**: 拖拽变换箭头时自动禁用相机控制，拖拽结束后自动恢复
5. **可视化反馈**: 提供拖拽状态指示和变换模式切换

**关键特性**:
- 支持悬停高亮效果
- 支持多种变换模式（translate/rotate/scale）
- 自动相机控制禁用/启用
- 完整的事件系统
- 响应式UI控制面板

## 修改的文件

### 原有修复
1. **src/utils/facePicking/FacePicker.js**
   - `handleClick` 方法：传递原始鼠标事件给 `selectFace`
   - `selectFace` 方法：接收并传递原始事件给事件发射器

2. **src/components/WorkspaceViewport.vue**
   - `faceSelected` 事件处理器：接收原始事件并转发给文字系统
   - 集成物体选择系统
   - 添加物体选择控制面板UI
   - 实现面拾取与物体选择的智能切换

3. **src/utils/surfaceText/SurfaceTextManager.js**
   - `enableTextMode` 方法：移除直接监听面拾取事件（改为通过WorkspaceViewport转发）
   - `disableTextMode` 方法：移除直接移除事件监听的代码
   - `handleFaceSelected` 方法：优先使用原始鼠标事件坐标，添加调试日志
   - `getDefaultTextConfig` 方法：调整默认文字大小和相关参数
   - `updateTextColor` 方法：修复选中状态下的颜色更新问题

### 新增文件（物体选择系统）
4. **src/utils/objectSelection/ObjectSelector.js** (新增)
   - 物体选择器，负责整个物体的选择和高亮

5. **src/utils/objectSelection/ObjectTransformControls.js** (新增)
   - 物体变换控制器，负责显示和处理拖动箭头

6. **src/utils/objectSelection/ObjectSelectionManager.js** (新增)
   - 物体选择管理器，统一管理选择和变换功能

7. **src/utils/objectSelection/index.js** (新增)
   - 物体选择系统入口文件

8. **src/utils/objectSelection/test-object-selection.js** (新增)
   - 物体选择功能的测试文件

9. **src/utils/surfaceText/test-color-update.js** (新增)
   - 颜色更新功能的测试文件

## 测试验证

创建了 `src/utils/surfaceText/test-fixes.js` 测试文件，包含：
- 输入框位置计算测试
- 文字大小配置测试  
- 鼠标事件传递测试

## 预期效果

### 原有功能
1. **输入框位置**: 点击面后，输入框将出现在鼠标点击的全局位置，而不是相对于DOM元素的位置
2. **文字大小**: 新创建的文字将使用大小为3、深度为0.5的配置，提供合适的视觉效果
3. **文字编辑**: 点击已存在的文字对象应该能够正常选中和编辑
4. **颜色更新**: 选中文字后修改颜色应该立即生效，无论文字是否处于选中状态

### 新增功能
5. **智能模式切换**: 
   - 启用面拾取时：可以选择网格的单个面，物体选择功能自动禁用
   - 禁用面拾取时：自动启用物体选择功能，可以选择整个物体

6. **物体选择和变换**: 
   - 点击物体可以选中整个物体，显示绿色高亮
   - 选中物体后自动显示变换控制器（拖动箭头）
   - 支持三种变换模式：移动、旋转、缩放

7. **相机控制管理**: 
   - 拖拽变换箭头时，相机控制（OrbitControls）自动禁用
   - 拖拽结束后，相机控制自动恢复
   - 控制面板显示当前拖拽状态

8. **用户界面**: 
   - 物体选择控制面板显示当前选中物体信息
   - 变换模式切换按钮
   - 拖拽状态实时指示
   - 清除选择按钮

## 使用方法

### 原有功能
1. 启动开发服务器：`npm run dev`
2. 在浏览器中打开应用
3. 点击"文字工具"按钮启用文字模式
4. 点击3D场景中的面，输入框应该出现在鼠标点击位置
5. 输入文字内容，生成的文字应该具有合理的大小
6. 点击已生成的文字可以选中并编辑

### 新增功能
7. **切换到物体选择模式**：
   - 点击面拾取面板中的"禁用"按钮
   - 物体选择面板将自动出现在右上角

8. **选择和操作物体**：
   - 点击场景中的任意物体（立方体、圆柱体、球体）进行选择
   - 选中的物体会显示绿色高亮和变换控制器箭头
   - 使用变换模式按钮切换移动/旋转/缩放模式

9. **拖拽操作**：
   - 拖拽变换箭头改变物体位置/旋转/缩放
   - 拖拽时相机控制自动禁用，控制面板显示"正在拖拽..."
   - 释放鼠标后相机控制自动恢复

10. **切换回面拾取模式**：
    - 点击面拾取面板中的"启用"按钮
    - 物体选择功能自动禁用，可以重新进行面拾取操作

## 注意事项

- 文字大小现在设置为3，深度为0.5，这些是用户指定的新默认值
- 输入框位置修复依赖于原始鼠标事件的正确传递，确保整个事件链路完整
- 物体选择和面拾取是互斥的，同时只能启用一种模式
- 拖拽变换箭头时相机控制会自动禁用，这是正常行为，用于避免操作冲突
- 物体选择系统使用Three.js的TransformControls，支持标准的变换操作
- 如果遇到问题，可以查看浏览器控制台的调试日志